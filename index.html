<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#111111">
  <title>Red/Green Timer v0.3</title>
  <link rel="manifest" href="manifest.webmanifest">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Ubuntu, Cantarell, 'Noto Sans', Helvetica, Arial, sans-serif;
      background-color: #111111;
      color: #FFFFFF;
      transition: background-color 0.3s ease;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    body.red-phase {
      background-color: #D32F2F;
    }

    body.green-phase {
      background-color: #2E7D32;
    }

    h1 {
      font-size: 2em;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
    }

    .version {
      font-size: 0.9em;
      color: #AAAAAA;
      text-align: center;
      margin-bottom: 20px;
    }

    .banner {
      background-color: #fff3cd;
      border: 2px solid #ffe69c;
      color: #856404;
      padding: 12px 20px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      max-width: 600px;
      width: 100%;
    }

    #setupScreen {
      width: 100%;
      max-width: 800px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .form-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .input-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    label {
      font-size: 1.0rem;
      color: #FFFFFF;
      flex-shrink: 0;
    }

    input[type="number"] {
      height: 42px;
      font-size: 1.0rem;
      border: none;
      border-radius: 4px;
      padding-left: 8px;
      padding-right: 2.6em;
      color: #000000;
      background-image: linear-gradient(to right,
        rgba(255,255,255,0) 0,
        rgba(255,255,255,0) calc(100% - 2.6em),
        rgba(255,255,255,0.25) calc(100% - 2.6em),
        rgba(255,255,255,0.25) 100%);
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
      filter: invert(1) contrast(1.25);
      height: 40px;
    }

    #cyclesInput {
      width: 90px;
      background-color: #FFFFFF;
    }

    #redInput {
      flex: 1;
      min-width: 100px;
      background-color: #D32F2F;
      color: #FFFFFF;
    }

    #greenInput {
      flex: 1;
      min-width: 100px;
      background-color: #2E7D32;
      color: #FFFFFF;
    }

    #routineSelect {
      width: 60%;
      min-width: 220px;
      height: 42px;
      background-color: #FFEB3B;
      color: #000000;
      border: none;
      border-radius: 4px;
      padding: 0 8px;
      font-size: 1.0rem;
    }

    #startBtn {
      width: 100%;
      height: 56px;
      background-color: #1976D2;
      color: #FFFFFF;
      font-size: 1.6em;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    #startBtn:hover {
      background-color: #1565C0;
    }

    #startBtn:active {
      background-color: #0D47A1;
    }

    .routine-list-panel {
      background-color: #FFEB3B;
      color: #000000;
      border-radius: 10px;
      padding: 15px;
      width: 100%;
      margin-top: 10px;
    }

    .routine-list-panel h3 {
      margin-bottom: 10px;
      font-size: 1.1rem;
    }

    .routine-list-panel ul {
      list-style: none;
      padding-left: 0;
    }

    .routine-list-panel li {
      font-size: 1.0rem;
      padding: 4px 0;
    }

    #timerScreen {
      display: none;
      width: 100%;
      max-width: 800px;
      text-align: center;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex-grow: 1;
    }

    #timerScreen.active {
      display: flex;
    }

    #countdown {
      font-size: clamp(96px, 37.5vh, 270px);
      font-weight: bold;
      line-height: 1;
      margin: 20px 0;
    }

    #routineItemName {
      font-size: clamp(48px, 10vh, 84px);
      font-weight: bold;
      margin-bottom: 30px;
    }

    .controls {
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .controls button {
      padding: 12px 30px;
      font-size: 1.2em;
      font-weight: bold;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #1976D2;
      color: #FFFFFF;
      transition: background-color 0.2s;
    }

    .controls button:hover {
      background-color: #1565C0;
    }

    .controls button:active {
      background-color: #0D47A1;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.5em;
      }

      .input-row {
        flex-direction: column;
        align-items: stretch;
      }

      #routineSelect {
        width: 100%;
      }

      input[type="number"] {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <h1>Red/Green Timer</h1>
  <div class="version">v0.3</div>

  <div id="banner" class="banner" style="display:none;">
    Couldn't load routines.json â€” using built-in routine list.
  </div>

  <div id="setupScreen">
    <div class="form-container">
      <div class="input-row">
        <label for="cyclesInput">Cycles:</label>
        <input type="number" id="cyclesInput" min="1" max="3" value="1">
      </div>

      <div class="input-row">
        <label for="routineSelect">Routine:</label>
        <select id="routineSelect">
          <option value="">Loading...</option>
        </select>
      </div>

      <div class="input-row">
        <label>Red (s):</label>
        <input type="number" id="redInput" min="1" value="30">
        <label>Green (s):</label>
        <input type="number" id="greenInput" min="1" value="15">
      </div>

      <button id="startBtn">Start</button>
    </div>

    <div class="routine-list-panel" id="routineListPanel">
      <h3 id="routineListTitle">Select a routine</h3>
      <ul id="routineListItems"></ul>
    </div>
  </div>

  <div id="timerScreen">
    <div id="countdown">00</div>
    <div id="routineItemName">Ready</div>
    <div class="controls">
      <button id="pauseBtn">Pause</button>
      <button id="stopBtn">Stop</button>
    </div>
  </div>

  <script>
    // ========================================
    // GLOBALS
    // ========================================
    let routines = {
      "Routine One": ["One", "Two", "Three", "Four", "Five"],
      "Over the hill": ["Help", "Me", "Now", "OK"],
      "Loosen Up Standing": ["Semi-Tandem Stand","Tightrope Walking","March & Hold","Kickstand Balance","Side Step","Heel Lifts"],
      "Strength Standing": ["Sit to Stand","Wall Push-Up","Split Squat","Standing Hip Abduction","Biceps Curl","Calf Raise","Deadlift"],
      "Cardio Standing": ["March","Mini Kicks","Side Toe Taps","Knee Ups","Hamstring Curl","V-Step Left","V-Step Right"],
      "Stretching Standing": ["Shoulder Rolls","Side Bends","Forward Fold","Quad Stretch","Hamstring Stretch","Calf Stretch"]
    };

    let audioContext;
    let audioUnlocked = false;
    let timerInterval;
    let isPaused = false;
    let remainingTime = 0;
    let currentPhase = 'red'; // 'red' or 'green'
    let currentCycle = 0;
    let totalCycles = 0;
    let redSeconds = 0;
    let greenSeconds = 0;
    let currentRoutine = [];
    let currentItemIndex = 0;
    let scheduledBeeps = [];

    const body = document.body;
    const setupScreen = document.getElementById('setupScreen');
    const timerScreen = document.getElementById('timerScreen');
    const countdown = document.getElementById('countdown');
    const routineItemName = document.getElementById('routineItemName');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const startBtn = document.getElementById('startBtn');
    const cyclesInput = document.getElementById('cyclesInput');
    const redInput = document.getElementById('redInput');
    const greenInput = document.getElementById('greenInput');
    const routineSelect = document.getElementById('routineSelect');
    const routineListItems = document.getElementById('routineListItems');
    const routineListTitle = document.getElementById('routineListTitle');
    const banner = document.getElementById('banner');

    // ========================================
    // AUDIO SETUP
    // ========================================
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function unlockAudio() {
      if (audioUnlocked) return;
      initAudio();
      const buffer = audioContext.createBuffer(1, 1, 22050);
      const source = audioContext.createBufferSource();
      source.buffer = buffer;
      source.connect(audioContext.destination);
      source.start(0);
      audioUnlocked = true;
    }

    function playBeep(frequency = 880, duration = 120) {
      if (!audioContext || audioContext.state === 'suspended') {
        initAudio();
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
      }

      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();

      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);

      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';

      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);

      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration / 1000);
    }

    function playEndChime() {
      playBeep(660, 120);
      setTimeout(() => playBeep(880, 120), 180);
      setTimeout(() => playBeep(1100, 120), 360);
    }

    // ========================================
    // ROUTINE LOADING
    // ========================================
    async function loadRoutines() {
      try {
        const response = await fetch('routines.json?ts=' + Date.now(), { cache: 'no-store' });
        if (!response.ok) throw new Error('Failed to fetch');
        const data = await response.json();
        routines = data.routines;
      } catch (error) {
        console.warn('Could not load routines.json, using built-in routines.');
        banner.style.display = 'block';
      }
      populateRoutineSelect();
    }

    function populateRoutineSelect() {
      routineSelect.innerHTML = '';
      const keys = Object.keys(routines);
      keys.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        routineSelect.appendChild(option);
      });
      if (keys.length > 0) {
        routineSelect.value = keys[0];
        updateRoutineList();
      }
    }

    function updateRoutineList() {
      const selectedRoutine = routineSelect.value;
      if (!selectedRoutine || !routines[selectedRoutine]) {
        routineListTitle.textContent = 'Select a routine';
        routineListItems.innerHTML = '';
        return;
      }
      routineListTitle.textContent = selectedRoutine;
      routineListItems.innerHTML = '';
      routines[selectedRoutine].forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        routineListItems.appendChild(li);
      });
    }

    // ========================================
    // TIMER LOGIC
    // ========================================
    function startTimer() {
      const cycles = parseInt(cyclesInput.value);
      const red = parseInt(redInput.value);
      const green = parseInt(greenInput.value);
      const selectedRoutine = routineSelect.value;

      if (!cycles || cycles < 1 || cycles > 3) {
        alert('Please enter a valid number of cycles (1-3).');
        return;
      }

      if (!red || red <= 0) {
        alert('Please enter a positive number of seconds for Red.');
        return;
      }

      if (!green || green <= 0) {
        alert('Please enter a positive number of seconds for Green.');
        return;
      }

      if (!selectedRoutine || !routines[selectedRoutine]) {
        alert('Please select a routine.');
        return;
      }

      unlockAudio();

      totalCycles = cycles;
      redSeconds = red;
      greenSeconds = green;
      currentRoutine = routines[selectedRoutine];
      currentCycle = 1;
      currentItemIndex = 0;
      currentPhase = 'red';
      remainingTime = redSeconds;
      isPaused = false;

      setupScreen.style.display = 'none';
      timerScreen.classList.add('active');
      body.classList.add('red-phase');
      body.classList.remove('green-phase');

      updateDisplay();
      scheduleBeeps();
      runTimer();
    }

    function runTimer() {
      timerInterval = setInterval(() => {
        if (isPaused) return;

        remainingTime--;
        updateDisplay();

        if (remainingTime <= 0) {
          nextPhase();
        }
      }, 1000);
    }

    function nextPhase() {
      if (currentPhase === 'red') {
        currentPhase = 'green';
        remainingTime = greenSeconds;
        currentItemIndex++;
        body.classList.remove('red-phase');
        body.classList.add('green-phase');
      } else {
        currentCycle++;
        if (currentCycle > totalCycles) {
          endTimer();
          return;
        }
        currentPhase = 'red';
        remainingTime = redSeconds;
        currentItemIndex++;
        body.classList.add('red-phase');
        body.classList.remove('green-phase');
      }

      updateDisplay();
      scheduleBeeps();
    }

    function updateDisplay() {
      countdown.textContent = remainingTime.toString().padStart(2, '0');
      
      if (currentItemIndex < currentRoutine.length) {
        routineItemName.textContent = currentRoutine[currentItemIndex];
      } else {
        routineItemName.textContent = 'Completed';
      }
    }

    function scheduleBeeps() {
      clearScheduledBeeps();
      
      for (let i = 5; i >= 1; i--) {
        if (i < remainingTime) {
          const timeout = setTimeout(() => {
            playBeep(880, 120);
          }, (remainingTime - i) * 1000);
          scheduledBeeps.push(timeout);
        }
      }
    }

    function clearScheduledBeeps() {
      scheduledBeeps.forEach(timeout => clearTimeout(timeout));
      scheduledBeeps = [];
    }

    function pauseTimer() {
      if (isPaused) {
        isPaused = false;
        pauseBtn.textContent = 'Pause';
        scheduleBeeps();
      } else {
        isPaused = true;
        pauseBtn.textContent = 'Resume';
        clearScheduledBeeps();
      }
    }

    function stopTimer() {
      clearInterval(timerInterval);
      clearScheduledBeeps();
      playEndChime();
      resetUI();
    }

    function endTimer() {
      clearInterval(timerInterval);
      clearScheduledBeeps();
      playEndChime();
      setTimeout(() => {
        resetUI();
      }, 1000);
    }

    function resetUI() {
      timerScreen.classList.remove('active');
      setupScreen.style.display = 'flex';
      body.classList.remove('red-phase', 'green-phase');
      pauseBtn.textContent = 'Pause';
      isPaused = false;
    }

    // ========================================
    // EVENT LISTENERS
    // ========================================
    startBtn.addEventListener('click', startTimer);
    pauseBtn.addEventListener('click', pauseTimer);
    stopBtn.addEventListener('click', stopTimer);
    routineSelect.addEventListener('change', updateRoutineList);

    // Audio unlock on first interaction
    ['click', 'touchstart', 'keydown'].forEach(event => {
      document.addEventListener(event, unlockAudio, { once: true });
    });

    // Resume audio context when page becomes visible
    document.addEventListener('visibilitychange', () => {
      if (!document.hidden && audioContext && audioContext.state === 'suspended') {
        audioContext.resume();
      }
    });

    // ========================================
    // SERVICE WORKER REGISTRATION
    // ========================================
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => {
        console.log('Service Worker registered');
      }).catch(err => {
        console.warn('Service Worker registration failed:', err);
      });
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    loadRoutines();
    console.log('Red/Green Timer v0.3 loaded successfully.');
  </script>

</body>
</html>